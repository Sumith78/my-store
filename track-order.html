<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Track Order</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #f4f6f8;
    }
    header {
      background-color: #074c63;
      color: white;
      padding: 1.2rem;
      text-align: center;
      font-size: 1.6rem;
      font-weight: bold;
      position: relative;
    }


    .container {
      width: 95%;
      max-width: 800px; /* increased width for desktop */
      margin: 2rem auto;
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .status-bar {
  display: flex;
  gap: 1.5rem;
  flex-wrap: nowrap;        /* ‚úÖ Forces single row */
  white-space: nowrap;
  scroll-behavior: smooth;
  min-height: 100px;
}

.status-bar::-webkit-scrollbar {
  height: 6px;
}
.status-bar::-webkit-scrollbar-thumb {
  background: #999;
  border-radius: 4px;
}


.status-step {
  text-align: center;
  min-width: 100px;
  color: #888;
  flex: 0 0 auto;
}

    
    .status-step.active {
      font-weight: bold;
      color: #074c63;
    }
    .circle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background-color: #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 0.5rem;
      color: white;
    }
    .status-step.active .circle {
      background-color: #074c63;
    }
    .action-btn-wrapper {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }
    .print-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      background-color: #074c63;
      color: white;
    }
    .cancel-btn {
      background-color: crimson;
    }
    .no-orders {
      text-align: center;
      color: #777;
      font-size: 1.4rem;
      margin-top: 4rem;
      animation: fadeIn 0.6s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .back-btn {
      position: absolute;
      left: 20px;
      top: 10px;
      font-size: 2rem;
      cursor: pointer;
      color: white;
      user-select: none;
      transition: transform 0.3s ease, color 0.3s ease;
    }
    .back-btn:hover {
      color: #ffd700;
      transform: translateX(-5px) scale(1.1);
    }
    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .summary h3 {
      margin-bottom: 1.5rem;
    }
    .status-bar {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 3rem;
    }
    @media (max-width: 600px) {
      .timeline-header div {
        width: 100%;
        margin-bottom: 1rem;
      }
      .summary, .status-bar, .action-btn-wrapper {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <span class="back-btn" onclick="window.location.href='index.html'">&#8592;</span>
    üì¶ Track Order
  </header>
  <div class="container" id="orderContainer"></div>
  <script>
    function getStatusSteps(dateStr) {
      const orderDate = new Date(dateStr);
      const today = new Date();
      const diffDays = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
      const steps = ["‚úî", "üì¶", "üöö", "üìç", "‚úÖ"];
      const labels = ["Order Placed", "Packed", "Shipped", "Out for Delivery", "Delivered"];
      return steps.map((icon, i) => `
        <div class="status-step ${diffDays >= i ? 'active' : ''}">
          <div class="circle">${icon}</div>
          <div>${labels[i]}</div>
        </div>
      `).join('');
    }

    function renderTrackOrder() {
      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      const checkout = JSON.parse(localStorage.getItem("checkoutDetails")) || {};
      const email = checkout.email || "guest@example.com";
      const userOrders = orders.filter(o => o.email === email && !o.cancelled);
    
      if (userOrders.length === 0) {
        document.getElementById("orderContainer").innerHTML = `<div class='no-orders'>üö´ No current orders to track</div>`;
        return;
      }
    
      const latestOrder = userOrders.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
      const orderDate = new Date(latestOrder.date);
    
      const paymentTag = latestOrder.paymentMode === 'COD'
        ? `<span style="color:red;font-weight:600"> - COD</span>`
        : `<span style="color:blue;font-weight:600"> - UPI</span>`;
    
      const content = `
        <div style="text-align:center; font-weight:600; font-size:1.05rem; margin-bottom:2.5rem;">
          ${latestOrder.email}
        </div>
    
        <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; margin-bottom:2.5rem;">
          <div><strong>Ordered on</strong><br>${orderDate.toDateString()}</div>
          <div style="text-align:right;"><strong>Estimated delivery</strong><br>by ${latestOrder.estimatedDelivery} ${paymentTag}</div>
        </div>
    
        <!-- ‚úÖ Scrollable Status Card -->
      <div style="background:#f1f1f1; border-radius:12px; padding:1rem 1.2rem; margin-bottom:1.5rem; overflow-x: auto;">
  <div class="status-bar" style="display:flex; gap:1.2rem; flex-wrap:nowrap; min-width:max-content;">
    ${getStatusSteps(latestOrder.date)}
  </div>
</div>

        </div>
    
        <div class="summary" style="text-align:left;">
          <h3 style="margin-bottom:1.5rem;">Summary ${paymentTag}</h3>
          <div style="margin-bottom: 2rem;">
            ${latestOrder.items.map(item => `
              <div class="item" style="display:flex; align-items:center; gap:1rem; margin-bottom:1.2rem;">
                <img src="${item.image}" width="50" height="50" style="border-radius: 8px;"> 
                <span>${item.name} ‚Äî ‚Çπ${item.price}</span>
              </div>
            `).join('')}
          </div>
    
          <div class="action-btn-wrapper" style="margin-top:2rem;">
            <button class="print-btn" onclick="printSummary()">üñ® Print Summary</button>
            <button class="print-btn cancel-btn" onclick="cancelLatestOrder()">‚ùå Cancel Order</button>
          </div>
        </div>
      `;
    
      document.getElementById("orderContainer").innerHTML = content;
    }
    

    renderTrackOrder();


    function cancelLatestOrder() {
      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      const email = JSON.parse(localStorage.getItem("checkoutDetails"))?.email || "guest@example.com";
  
      const index = orders.map((o, i) => ({ o, i }))
        .filter(obj => obj.o.email === email && !obj.o.cancelled)
        .map(x => x.i)
        .pop();
  
      if (index !== undefined) {
        if (confirm("Are you sure you want to cancel this order?")) {
          orders[index].cancelled = true;
          localStorage.setItem("orders", JSON.stringify(orders));
          alert("‚úÖ Your order has been cancelled.");
          renderTrackOrder();
        }
      }
    }



    async function printSummary() {
      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      const addressData = JSON.parse(localStorage.getItem("checkoutDetails")) || {};
      const latestOrder = orders.slice(-1)[0];
    
      const companyName = "Mahaveer Enterprises";
      const email = latestOrder.email;
      const paymentMode = latestOrder.paymentMode || "N/A";
    
      const rawAddress = localStorage.getItem("deliveryAddress");
      const address = rawAddress 
        || `${addressData.name || "Name not found"}<br>${addressData.currentAddress || "Address not found"}`;
    
      const orderDate = new Date(latestOrder.date);
      const today = new Date();
      const diffDays = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
    
      const steps = [
        { name: "Order Placed", icon: "‚úî" },
        { name: "Packed", icon: "üì¶" },
        { name: "Shipped", icon: "üöö" },
        { name: "Out for Delivery", icon: "üìç" },
        { name: "Delivered", icon: "‚úÖ" }
      ];
    
      const statusHTML = steps.map((step, i) => {
        return `<li>${diffDays >= i ? '‚úÖ' : '‚¨ú'} ${step.name}</li>`;
      }).join('');
    
      const itemsHTML = latestOrder.items.map(item => `
        <li class="item">
          <img src="${item.image || 'https://via.placeholder.com/50'}" />
          ${item.name} ‚Äî ‚Çπ${item.price}
        </li>
      `).join('');
    
      const choice = confirm("Click OK to Print, or Cancel to Download PDF");
    
      if (choice) {
        const w = window.open();
        w.document.write(`
          <html>
            <head>
              <title>Order Summary</title>
              <style>
  body { font-family: Arial, sans-serif; padding: 30px; }
  h2 { text-align: center; color: #074c63; }
  .section { margin-bottom: 25px; }
  ul { padding-left: 20px; }
  .item { margin-bottom: 10px; }
  img { width: 50px; height: 50px; object-fit: cover; vertical-align: middle; margin-right: 10px; border-radius: 8px; }
  .label { font-weight: bold; color: #333; }
  hr { margin: 20px 0; border: none; border-top: 1px solid #ccc; }

  @media print {
    @page {
      margin: 0;
    }
    body {
      margin: 0;
    }
  }
</style>

            </head>
            <body>
              <h2>${companyName} - Order Summary</h2>
    
              <div class="section"><span class="label">Email:</span> ${email}</div>
              <div class="section"><span class="label">Delivery Address:</span><br>${address}</div>
              <div class="section"><span class="label">Ordered on:</span> ${orderDate.toDateString()}</div>
              <div class="section"><span class="label">Estimated Delivery:</span> ${latestOrder.estimatedDelivery}</div>
              <div class="section"><span class="label">Payment Mode:</span> ${paymentMode}</div>
              
              <hr>
    
              <div class="section">
                <span class="label">Order Status:</span>
                <ul>${statusHTML}</ul>
              </div>
    
              <hr>
    
              <div class="section">
                <span class="label">Items Ordered:</span>
                <ul>${itemsHTML}</ul>
              </div>
            </body>
          </html>
        `);
        w.document.close();
        w.print();
      } else {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 10;
    
        doc.setFontSize(16);
        doc.text(`${companyName} - Order Summary`, 10, y); y += 10;
    
        doc.setFontSize(12);
        doc.text(`Email: ${email}`, 10, y); y += 8;
        doc.text(`Delivery Address: ${address.replace(/<br>/g, ', ')}`, 10, y); y += 8;
        doc.text(`Ordered on: ${orderDate.toDateString()}`, 10, y); y += 8;
        doc.text(`Estimated delivery: ${latestOrder.estimatedDelivery}`, 10, y); y += 8;
        doc.text(`Payment Mode: ${paymentMode}`, 10, y); y += 12;
    
        doc.text("Order Status:", 10, y); y += 8;
        steps.forEach((step, i) => {
          doc.text(`${diffDays >= i ? '‚úÖ' : '‚¨ú'} ${step.name}`, 12, y);
          y += 8;
        });
    
        y += 5;
        doc.text("Items:", 10, y); y += 8;
        latestOrder.items.forEach(item => {
          doc.text(`- ${item.name} ‚Äî ‚Çπ${item.price}`, 12, y);
          y += 8;
        });
    
        doc.save("Order_Summary.pdf");
      }
    }

    
  </script>
</body>
</html>
