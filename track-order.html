<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Track Order</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
     :root {
      --primary: #1976d2;
      --primary-dark: #0d47a1;
      --primary-light: #e3f2fd;
      --success: #28a745;
      --success-light: #e6f6ec;
      --danger: #dc3545;
      --danger-light: #fdecec;
      --warning: #ffc107;
      --warning-light: #fff8e1;
      --text: #333333;
      --text-light: #666666;
      --border: #e0e0e0;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --radius: 12px;
    }
    

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    /* Header */
    header {
      background: var(--primary);
      color: white;
      padding: 1.2rem;
      text-align: center;
      font-size: 1.3rem;
      font-weight: 600;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
      height: 70px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .back-btn {
      position: absolute;
      left: 1.5rem;
      background: none;
      border: none;
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .back-btn:hover {
      color: #ffd700;
      transform: translateX(-3px);
    }

    /* Main Container */
    .container {
      width: 95%;
      max-width: 900px;
      margin: 90px auto 2rem;
      background-color: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }

    /* Search Box */
    .search-box {
      display: flex;
      margin-bottom: 1.5rem;
    }

    .search-box input {
      flex: 1;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius) 0 0 var(--radius);
      outline: none;
      background-color: var(--card-bg);
      color: var(--text);
    }

    .search-box button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 0 var(--radius) var(--radius) 0;
      transition: var(--transition);
    }

    .search-box button:hover {
      background: var(--primary-dark);
    }

    /* Order Card */
    .order-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .order-id {
      font-weight: 600;
      color: var(--primary);
    }

    .order-items {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .order-items img {
      width: 60px;
      height: 60px;
      border-radius: var(--radius);
      object-fit: cover;
      border: 1px solid var(--border);
    }

    .order-actions {
      margin-top: 1.5rem;
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .order-actions button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .order-actions button:hover {
      background: var(--primary-dark);
    }

    .order-actions .cancel-btn {
      background: var(--danger);
    }

    .order-actions .cancel-btn:hover {
      background: #c82333;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 3rem;
    }

    .status-step {
      text-align: center;
      min-width: 100px;
      color: #888;
      flex: 0 0 auto;
    }

    .status-step.active {
      font-weight: bold;
      color: var(--primary);
    }

    .status-step .circle {
      width: 32px;
      height: 32px;
      background: #ccc;
      border-radius: 50%;
      margin: 0 auto 8px;
      line-height: 32px;
      font-size: 18px;
      color: white;
    }

    .status-step.active .circle {
      background-color: var(--primary);
    }

    /* Action Buttons */
    .action-btn-wrapper {
      display: flex;
      justify-content: center;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }

    .action-btn-wrapper button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .action-btn-wrapper button:hover {
      background: var(--primary-dark);
    }

    .action-btn-wrapper .cancel-btn {
      background: var(--danger);
    }

    .action-btn-wrapper .cancel-btn:hover {
      background: #c82333;
    }

    .print-btn {
      background: var(--primary) !important;
    }

    /* Timeline */
    .timeline-scroll {
      overflow-x: auto;
      overflow-y: hidden;
      scroll-behavior: smooth;
      padding-bottom: 12px;
    }
    
    .timeline-scroll::-webkit-scrollbar {
      height: 6px;
    }
    
    .timeline-scroll::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    .timeline-scroll::-webkit-scrollbar-track {
      background: #eee;
    }

    .timeline-wrapper {
      position: relative;
      height: 80px;
      margin: 20px 40px;
      min-width: 600px;
    }

    .progress-line {
      position: absolute;
      top: 18px;
      left: 0;
      right: 0;
      height: 6px;
      background-color: #ccc;
      border-radius: 10px;
      z-index: 1;
    }

    .progress-fill {
      position: absolute;
      top: 18px;
      left: 0;
      height: 6px;
      background-color: var(--primary);
      border-radius: 3px;
      z-index: 2;
      width: 0%;
      transition: width 0.5s ease-in-out;
    }

    .timeline-step {
      position: absolute;
      top: 5px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #ccc;
      color: white;
      text-align: center;
      line-height: 32px;
      font-size: 16px;
      z-index: 3;
      transition: background-color 0.4s ease;
    }

    .timeline-step.active {
      background: var(--primary);
    }

    .timeline-label {
      position: absolute;
      top: 42px;
      transform: translateX(-50%);
      font-size: 12px;
      color: #555;
      text-align: center;
    }

    .current-label {
      position: absolute;
      top: -28px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: bold;
      color: var(--primary);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.3; transform: translateX(-50%) scale(1); }
      50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
      100% { opacity: 0.3; transform: translateX(-50%) scale(1); }
    }

    /* No Orders */
    .no-orders {
      text-align: center;
      color: var(--text-light);
      font-size: 1.4rem;
      margin-top: 4rem;
      animation: fadeIn 0.6s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Cancellation Modal */
    .cancellation-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .cancellation-modal-content {
      background-color: var(--card-bg);
      width: 90%;
      max-width: 500px;
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cancellation-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .cancellation-modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
    }

    .close-cancellation-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
    }

    .cancellation-reason-options {
      margin-bottom: 1.5rem;
    }

    .reason-option {
      display: block;
      margin-bottom: 0.8rem;
      padding: 0.8rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .reason-option:hover {
      background-color: var(--bg);
      border-color: var(--primary);
    }

    .reason-option.selected {
      background-color: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary);
    }

    .custom-reason-container {
      margin-top: 1rem;
    }

    .custom-reason-textarea {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
      background-color: var(--card-bg);
      color: var(--text);
    }

    .cancellation-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.8rem;
      margin-top: 1.5rem;
    }

    .cancellation-modal-btn {
      padding: 0.6rem 1.2rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .cancellation-modal-btn.cancel {
      background: var(--text-light);
      color: white;
      border: none;
    }

 

    .cancellation-modal-btn.submit {
      background: var(--danger);
      color: white;
      border: none;
    }

    .cancellation-modal-btn.submit:hover {
      background: #c82333;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .order-header {
        flex-direction: column;
        gap: 0.5rem;
      }

      .order-actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .timeline-wrapper {
        margin: 20px;
        min-width: 400px;
      }
    }

    @media (max-width: 480px) {
      header {
        padding: 1rem;
        font-size: 1.1rem;
      }

      .back-btn {
        left: 1rem;
        font-size: 1.1rem;
      }

      .search-box button {
        padding: 0 1rem;
      }

      .timeline-wrapper {
        min-width: 300px;
      }
    }
  </style>
</head>
<body>
  <header>
    <button class="back-btn" onclick="window.location.href='index.html'">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="header-title">
      <i class="fas fa-shopping-bag"></i>
      Track Order
    </div>
  </header>

  <div class="container">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Enter Order ID..." />
      <button onclick="searchOrder()">
        <i class="fas fa-search"></i> Search
      </button>
    </div>
 <div id="ordersContainer"></div>
<div id="orderDetailsContainer"></div> <!-- ‚úÖ Add this -->

<Detailed view when clicking "Show Details" -->

  </div>
  <script>


    // üíæ Seed some mock data for testing (only runs once)
if (!localStorage.getItem("orders")) {
  const testOrders = [{
    id: "ORDER123",
    email: "guest@example.com",
    date: new Date().toISOString(),
    estimatedDelivery: "2025-07-15",
    paymentMode: "COD",
    cancelled: false,
    items: [
      {
        name: "Wireless Mouse",
        price: 799,
        image: "https://via.placeholder.com/60x60?text=Mouse"
      },
      {
        name: "Keyboard",
        price: 1299,
        image: "https://via.placeholder.com/60x60?text=Keyboard"
      }
    ]
  }];

  localStorage.setItem("orders", JSON.stringify(testOrders));

  const checkoutDetails = {
    email: "guest@example.com",
    name: "Sumith Singh",
    currentAddress: "123, Example Street",
    city: "Bangalore",
    state: "KA",
    pincode: "560001",
    phone: "9739170288"
  };

  localStorage.setItem("checkoutDetails", JSON.stringify(checkoutDetails));
}

    function getStatusSteps(dateStr) {
      const orderDate = new Date(dateStr);
      const today = new Date();
      const diffDays = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
      const steps = ["‚úî", "üì¶", "üöö", "üìç", "‚úÖ"];
      const labels = ["Order Placed", "Packed", "Shipped", "Out for Delivery", "Delivered"];
      return steps.map((icon, i) => `
        <div class="status-step ${diffDays >= i ? 'active' : ''}">
          <div class="circle">${icon}</div>
          <div>${labels[i]}</div>
        </div>
      `).join('');
    }
    
document.getElementById("searchInput")?.addEventListener("keyup", function (e) {
  if (e.key === "Enter") searchOrder();
});


function searchOrder() {
  const searchId = document.getElementById("searchInput").value.trim();
  if (!searchId) return;

  const orders = JSON.parse(localStorage.getItem("orders")) || [];
 const order = orders.find(o => o.id.toLowerCase().includes(searchId.toLowerCase()));

  if (order) {
    showOrderDetails(order.id);
  } else {
    alert("‚ùå No matching order found.");
  }
}



function renderAllOrders() {
  const orders = JSON.parse(localStorage.getItem("orders")) || [];
  const checkout = JSON.parse(localStorage.getItem("checkoutDetails")) || {};
  const email = checkout.email || "guest@example.com";

  const activeOrders = orders
    .filter(order => order.email === email && !order.cancelled)
    .sort((a, b) => new Date(b.date) - new Date(a.date)); // Descending by date

  const container = document.getElementById("ordersContainer");
  container.innerHTML = "";

  if (activeOrders.length === 0) {
    container.innerHTML = `<div class='no-orders'>üö´ No current active orders found</div>`;
    return;
  }

  activeOrders.forEach(order => {
    const orderCard = document.createElement("div");
    orderCard.className = "order-card";
    orderCard.setAttribute("data-id", order.id || order.orderId);

    const orderDate = new Date(order.date);

    const itemsHTML = order.items.map(item => `
      <div style="text-align:center;">
        <img src="${item.image}" alt="${item.name}" />
        <div>${item.name}</div>
      </div>
    `).join("");

    const itemDetails = order.items.map(item => `
      <div class="item" style="display:flex; align-items:center; gap:1rem; margin-bottom:1.2rem;">
        <img src="${item.image}" width="50" height="50" style="border-radius: 8px;"> 
        <span>${item.name} ‚Äî ‚Çπ${item.price}</span>
      </div>
    `).join("");

 const paymentMethod = order.paymentMethod || order.paymentMode || 'UPI'; // Default to UPI if neither exists
const paymentTag = paymentMethod === 'COD'
  ? `<span style="color:red;font-weight:600"> - COD</span>`
  : `<span style="color:blue;font-weight:600"> - UPI</span>`;

    orderCard.innerHTML = `
      <div class="order-header">
        <div>
          <div class="order-id">Order ID: ${order.id || order.orderId || 'N/A'}</div>
          <div>Ordered on: ${orderDate.toDateString()}</div>
          <div>Payment: ${paymentMethod || 'Not specified'}</div>
        </div>
        <div style="text-align:right;">
          <div><strong>Estimated Delivery:</strong></div>
          <div>${order.estimatedDelivery}</div>
        </div>
      </div>

      <div class="order-items">${itemsHTML}</div>

      <div style="margin-top: 1rem; font-weight: bold;">
        Total Quantity: ${order.items.length} <br>
        Total Amount: ‚Çπ${order.items.reduce((sum, item) => sum + item.price, 0)}
      </div>

      <div class="order-actions">
        <button onclick="toggleDetails(this)">Show Details</button>
        ${order.cancelled
          ? `<span style="color:crimson;font-weight:bold;">‚ùå Order Cancelled</span>`
          : `<button class="cancel-btn" onclick="cancelOrder('${order.id}')">‚ùå Cancel Order</button>`}
      </div>

      <div class="tracking-details" style="display:none; margin-top:1.5rem;">
        <div style="background:#f9f9f9; padding:1rem; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div><strong>Estimated Delivery:</strong> ${order.estimatedDelivery} ${paymentTag}</div>
          <div><strong>Items:</strong></div>
          ${itemDetails}

          <!-- ‚úÖ Tracking Status Card -->
          <div class="status-card" style="margin-top:1.5rem; background:#ffffff; padding:1rem; border-radius:10px; box-shadow: 0 1px 6px rgba(0,0,0,0.08);">
            <div style="font-weight:bold; margin-bottom:1rem; font-size:1.1rem; color:#074c63;">üì¶ Order Tracking Progress</div>
            <div class="timeline-scroll">
              <div class="timeline-wrapper">
                <div class="progress-line"></div>
                <div class="progress-fill" id="progressFill-${order.id}"></div>
              </div>
            </div>
          </div>

          <div class="action-btn-wrapper" style="margin-top: 1.5rem;">
           <button class="print-btn" onclick="printSummary('${order.id || order.orderId}')">üñ® Print Summary</button>
            ${order.cancelled
              ? `<span style="color:crimson;font-weight:bold;">‚ùå Order Cancelled</span>`
              : `<button class="cancel-btn" onclick="cancelOrder('${order.id}')">‚ùå Cancel Order</button>`}
          </div>
        </div>
      </div>
    `;

    container.appendChild(orderCard);
  });
}

    
  
function createProgressTimeline(orderDateStr, fillId = "progressFill") {
  const steps = ["‚úî", "üì¶", "üöö", "üìç", "‚úÖ"];
  const labels = ["Order Placed", "Packed", "Shipped", "Out for Delivery", "Delivered"];
  const total = steps.length;
  const orderDate = new Date(orderDateStr);
  const today = new Date();
  const diffDays = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));

  const progress = document.getElementById(fillId);
  if (!progress) return;

  const container = progress.closest(".timeline-wrapper");
  if (!container) return;

  // Remove old steps if re-rendered
  container.querySelectorAll(".timeline-step, .timeline-label, .current-label").forEach(el => el.remove());

  const gapPercent = 100 / (total - 1);

  steps.forEach((icon, i) => {
    const leftPercent = i * gapPercent;

    const circle = document.createElement("div");
    circle.className = "timeline-step" + (diffDays >= i ? " active" : "");
    circle.style.left = `calc(${leftPercent}% - 16px)`;
    circle.innerHTML = icon;
    container.appendChild(circle);

    const label = document.createElement("div");
    label.className = "timeline-label";
    label.style.left = `${leftPercent}%`;
    label.innerText = labels[i];
    container.appendChild(label);

    if (diffDays === i) {
      const current = document.createElement("div");
      current.className = "current-label";
      current.innerText = "Current";
      circle.appendChild(current);
    }
  });

  const fillPercent = Math.min((diffDays / (total - 1)) * 100, 100);
  progress.style.width = `${fillPercent}%`;
}


function toggleDetails(button) {
  const trackingDetails = button.parentElement.nextElementSibling;

  if (trackingDetails.style.display === "none") {
    trackingDetails.style.display = "block";
    button.textContent = "Hide Details";

    const orderCard = button.closest(".order-card");
    const orderId = orderCard.getAttribute("data-id");

    // üß† Avoid duplicate initialization
    const alreadyInitialized = orderCard.getAttribute("data-timeline-init");
    if (!alreadyInitialized) {
      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      const thisOrder = orders.find(o => o.id === orderId);
      if (thisOrder) {
        createProgressTimeline(thisOrder.date, `progressFill-${orderId}`);
        orderCard.setAttribute("data-timeline-init", "true");
      }
    }

  } else {
    trackingDetails.style.display = "none";
    button.textContent = "Show Details";
  }

  
}



  
  




    function cancelLatestOrder() {
      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      const email = JSON.parse(localStorage.getItem("checkoutDetails"))?.email || "guest@example.com";
  
      const index = orders.map((o, i) => ({ o, i }))
        .filter(obj => obj.o.email === email && !obj.o.cancelled)
        .map(x => x.i)
        .pop();
  
      if (index !== undefined) {
        if (confirm("Are you sure you want to cancel this order?")) {
          orders[index].cancelled = true;
          localStorage.setItem("orders", JSON.stringify(orders));
          alert("‚úÖ Your order has been cancelled.");
          renderTrackOrder();
        }
      }
    }



    async function printSummary(orderID) {
  if (!orderID) {
    alert("‚ùå No order ID provided");
    return;
  }

  // Fetch order details
  const orders = JSON.parse(localStorage.getItem("orders")) || [];
  const order = orders.find(o => o.id === orderID || o.orderId === orderID);
  
  if (!order) {
    alert("‚ùå Order not found.");
    return;
  }

  // Fetch customer details from checkout data
  const deliveryDetails = JSON.parse(localStorage.getItem("deliveryDetails")) || {};
  const orderDate = new Date(order.date);
  const formattedDate = orderDate.toLocaleDateString('en-IN', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });

  // Business Information
  const companyInfo = {
    name: "MAHAVEER ENTERPRISES",
    gstin: "29GHUPS1629Q1ZZ",
    address: "Guestline, Bengaluru, Karnataka 562107",
    phone: "+91 9739170288",
    email: "mahaveerenterprises0118@gmail.com"
  };

  // Customer details from checkout form
  const customerDetails = {
    name: deliveryDetails.name || "Customer Name not found",
    email: deliveryDetails.email || "guest@example.com",
    phone: deliveryDetails.phone || "N/A",
    address: deliveryDetails.address || "Address not found",
    city: deliveryDetails.city || "",
    state: deliveryDetails.state || "",
    zip: deliveryDetails.zip || "",
    notes: deliveryDetails.notes || ""
  };

  // Payment details from order with correct status logic
  const paymentMethod = order.paymentMethod || order.paymentMode || "COD";
  const paymentStatus = paymentMethod === "COD" ? "Pending" : "Paid";
  
  const paymentDetails = {
    mode: paymentMethod,
    status: paymentStatus,
    orderId: order.orderId || order.id || "N/A"
  };

  // Calculate totals
  const subtotal = order.items.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
  const shipping = order.shippingFee || 0;
  const tax = order.tax || 0;
  const total = subtotal + shipping + tax;

  // Format delivery address
  const deliveryAddress = `
    ${customerDetails.name}<br>
    ${customerDetails.address}<br>
    ${customerDetails.city}, ${customerDetails.state} - ${customerDetails.zip}<br>
    Phone: ${customerDetails.phone}
  `;

  // Format payment mode for display
  const formattedPaymentMode = paymentMethod === 'UPI' ? 'UPI Payment' : 
                             paymentMethod === 'COD' ? 'Cash on Delivery' : 
                             paymentMethod;

  // Order items table
  const itemsHTML = order.items.map(item => `
    <tr>
      <td class="product-info">
        <img src="${item.image || 'https://via.placeholder.com/50'}" />
        <div>
          <div class="product-name">${item.name}</div>
          ${item.description ? `<div class="product-desc">${item.description}</div>` : ''}
        </div>
      </td>
      <td class="text-center">${item.quantity || 1}</td>
      <td class="text-right">‚Çπ${item.price.toFixed(2)}</td>
      <td class="text-right">‚Çπ${(item.price * (item.quantity || 1)).toFixed(2)}</td>
    </tr>
  `).join('');

  // Payment summary
  const paymentSummaryHTML = `
    <div class="payment-summary-row">
      <span>Subtotal:</span>
      <span>‚Çπ${subtotal.toFixed(2)}</span>
    </div>
    ${shipping > 0 ? `
    <div class="payment-summary-row">
      <span>Shipping:</span>
      <span>‚Çπ${shipping.toFixed(2)}</span>
    </div>` : ''}
    ${tax > 0 ? `
    <div class="payment-summary-row">
      <span>Tax (GST):</span>
      <span>‚Çπ${tax.toFixed(2)}</span>
    </div>` : ''}
    <div class="payment-summary-row total">
      <span>Total Amount:</span>
      <span>‚Çπ${total.toFixed(2)}</span>
    </div>
  `;

  const printHTML = `
    <html>
      <head>
        <title>Invoice #${paymentDetails.orderId}</title>
        <style>
          @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');
          
          :root {
            --primary-color: #1976d2;
            --secondary-color: #0d47a1;
            --text-color: #333333;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #757575;
          }
          
          * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
          }
          
          body {
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            line-height: 1.6;
            padding: 40px;
            background-color: #fff;
          }
          
          .invoice-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
          }
          
          .invoice-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            text-align: center;
          }
          
          .invoice-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
          }
          
          .invoice-subtitle {
            font-size: 14px;
            opacity: 0.9;
          }
          
          .invoice-body {
            padding: 30px;
          }
          
          .company-info {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
          }
          
          .company-logo {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
          }
          
          .company-details {
            text-align: right;
            font-size: 14px;
          }
          
          .invoice-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
          }
          
          .invoice-details, .customer-details {
            flex: 1;
          }
          
          .section-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--medium-gray);
          }
          
          .detail-row {
            display: flex;
            margin-bottom: 8px;
          }
          
          .detail-label {
            font-weight: 500;
            min-width: 120px;
            color: var(--dark-gray);
          }
          
          .detail-value {
            flex: 1;
          }
          
          .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
          }
          
          .items-table th {
            background-color: var(--light-gray);
            padding: 12px 15px;
            text-align: left;
            font-weight: 500;
          }
          
          .items-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--medium-gray);
          }
          
          .product-info {
            display: flex;
            align-items: center;
          }
          
          .product-info img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
          }
          
          .product-name {
            font-weight: 500;
          }
          
          .product-desc {
            font-size: 13px;
            color: var(--dark-gray);
            margin-top: 3px;
          }
          
          .text-center {
            text-align: center;
          }
          
          .text-right {
            text-align: right;
          }
          
          .payment-summary {
            background-color: var(--light-gray);
            padding: 20px;
            border-radius: 6px;
            margin-top: 30px;
            max-width: 300px;
            margin-left: auto;
          }
          
          .payment-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
          }
          
          .payment-summary-row.total {
            font-weight: 600;
            font-size: 18px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--medium-gray);
          }
          
          .invoice-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--medium-gray);
            text-align: center;
            font-size: 14px;
            color: var(--dark-gray);
          }
          
          .terms {
            margin-top: 30px;
            font-size: 13px;
            color: var(--dark-gray);
          }
          
          @media print {
            @page {
              size: A4;
              margin: 0;
            }
            body {
              padding: 0;
              background: white;
            }
            .invoice-container {
              box-shadow: none;
              border-radius: 0;
            }
          }
        </style>
      </head>
      <body>
        <div class="invoice-container">
          <div class="invoice-header">
            <div class="invoice-title">ORDER INVOICE - MAHAVEER ENTERPRISES</div>
            <div class="invoice-subtitle">#${paymentDetails.orderId}</div>
          </div>
          
          <div class="invoice-body">
            <div class="company-info">
              <div>
                <div class="company-logo">${companyInfo.name}</div>
                <div>GSTIN: ${companyInfo.gstin}</div>
              </div>
              <div class="company-details">
                <div>${companyInfo.address}</div>
                <div>${companyInfo.phone} | ${companyInfo.email}</div>
              </div>
            </div>
            
            <div class="invoice-meta">
              <div class="invoice-details">
                <div class="section-title">Order Details</div>
                <div class="detail-row">
                  <div class="detail-label">Order Number:</div>
                  <div class="detail-value">#${paymentDetails.orderId}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Order Date:</div>
                  <div class="detail-value">${formattedDate}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Payment Method:</div>
                  <div class="detail-value">${formattedPaymentMode}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Payment Status:</div>
                  <div class="detail-value">${paymentDetails.status}</div>
                </div>
              </div>
              
              <div class="customer-details">
                <div class="section-title">Customer Details</div>
                <div class="detail-row">
                  <div class="detail-label">Name:</div>
                  <div class="detail-value">${customerDetails.name}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Email:</div>
                  <div class="detail-value">${customerDetails.email}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Phone:</div>
                  <div class="detail-value">${customerDetails.phone}</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Delivery Address:</div>
                  <div class="detail-value">${deliveryAddress}</div>
                </div>
              </div>
            </div>
            
            <div class="section-title">Order Items</div>
            <table class="items-table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Qty</th>
                  <th>Unit Price</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHTML}
              </tbody>
            </table>
            
            <div class="payment-summary">
              ${paymentSummaryHTML}
            </div>
            
            ${customerDetails.notes ? `
            <div class="section">
              <div class="section-title">Delivery Instructions</div>
              <div>${customerDetails.notes}</div>
            </div>` : ''}
            
            <div class="terms">
              <p><strong>Terms & Conditions:</strong></p>
              <p>1. Goods once sold will not be taken back.</p>
              <p>2. Please quote the order number in all correspondence.</p>
              <p>3. For returns or exchanges, please contact customer support within 7 days.</p>
            </div>
            
            <div class="invoice-footer">
              <p>Thank you for shopping with ${companyInfo.name}!</p>
              <p>For any queries, please contact our customer support at ${companyInfo.phone}</p>
            </div>
          </div>
        </div>
      </body>
    </html>
  `;

  const choice = confirm("Click OK to Print, or Cancel to Download PDF");
  const w = window.open();
  w.document.write(printHTML);
  w.document.close();
  
  if (choice) {
    setTimeout(() => w.print(), 500);
  } else {
    alert("‚ùå PDF download is not available unless jsPDF is included.");
  }
}
    

let lastShownOrderId = null;

function showOrderDetails(orderId) {
  const container = document.getElementById("orderDetailsContainer");
  const orders = JSON.parse(localStorage.getItem("orders")) || [];
const order = orders.find(o => o.id === orderId || o.orderId === orderId);



  if (!order) return;

  if (lastShownOrderId === orderId) {
    container.innerHTML = "";
    lastShownOrderId = null;
    return;
  }

  lastShownOrderId = orderId;

  const orderDate = new Date(order.date);
  const paymentTag = order.paymentMode === 'COD'
    ? `<span style="color:red;font-weight:600"> - COD</span>`
    : `<span style="color:blue;font-weight:600"> - UPI</span>`;

  const itemHTML = order.items.map(item => `
    <div class="item" style="display:flex; align-items:center; gap:1rem; margin-bottom:1.2rem;">
      <img src="${item.image}" width="50" height="50" style="border-radius: 8px;"> 
      <span>${item.name} ‚Äî ‚Çπ${item.price}</span>
    </div>
  `).join('');

  const summaryHTML = `
    <div class="container" style="background:white;">
      <h3>üì¶ Order Details</h3>
      <div><strong>Order ID:</strong> ${order.id}</div>
      <div><strong>Ordered on:</strong> ${orderDate.toDateString()}</div>
      <div><strong>Estimated Delivery:</strong> ${order.estimatedDelivery} ${paymentTag}</div>
      <div><strong>Items:</strong></div>
      ${itemHTML}


      <div style="margin: 1rem 0; font-weight: bold;">
  Total Quantity: ${order.items.length} <br>
  Total Amount: ‚Çπ${order.items.reduce((sum, item) => sum + item.price, 0)}
</div>

      <div class="timeline-scroll">
        <div class="timeline-wrapper">
          <div class="progress-line"></div>
          <div class="progress-fill" id="progressFill-${order.id}"></div>

        </div>
      </div>

      <div class="action-btn-wrapper">
       <button class="print-btn" onclick="printSummary('${order.id}')">üñ® Print Summary</button>

        <button class="cancel-btn" onclick="cancelOrder('${order.id}')">‚ùå Cancel Order</button>
      </div>
    </div>
  `;

  container.innerHTML = summaryHTML;
 createProgressTimeline(order.date, `progressFill-${order.id}`);

}



  // Cancel order logic
<!-- ‚úÖ Copy-paste entire code from your original file as is. -->
<!-- üü¢ No changes in CSS section needed if already added. -->
<!-- üîª Below are changes only to be made inside JavaScript <script> block -->

<!-- ‚úÖ Replace this section inside your existing script: -->

let currentCancellingOrderId = null;

function showCancellationModal(orderId) {
  currentCancellingOrderId = orderId;
  const modal = document.getElementById('cancellationModal');
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  
  // Reset modal state
  document.querySelectorAll('.reason-option').forEach(option => {
    option.classList.remove('selected');
  });
  document.getElementById('customReasonTextarea').style.display = 'none';
  document.getElementById('customReasonTextarea').value = '';
}

function closeCancellationModal() {
  const modal = document.getElementById('cancellationModal');
  modal.style.display = 'none';
  document.body.style.overflow = 'auto';
  currentCancellingOrderId = null;
}

function cancelOrder(orderId) {
  showCancellationModal(orderId);
}

// Handle modal interactions
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('cancellationModal');
  
  // Reason selection
  document.querySelectorAll('.reason-option').forEach(option => {
    option.addEventListener('click', function() {
      document.querySelectorAll('.reason-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      this.classList.add('selected');
      
      // Show textarea only if "Other reason" is selected
      const textarea = document.getElementById('customReasonTextarea');
      if (this.dataset.reason === 'Other reason') {
        textarea.style.display = 'block';
      } else {
        textarea.style.display = 'none';
      }
    });
  });
  
  // Close modal when clicking X or cancel button
  document.querySelector('.close-cancellation-modal').addEventListener('click', closeCancellationModal);
  document.querySelector('.cancellation-modal-btn.cancel').addEventListener('click', closeCancellationModal);
  
  // Submit cancellation
  document.querySelector('.cancellation-modal-btn.submit').addEventListener('click', function() {
    if (!currentCancellingOrderId) return;
    
    const selectedOption = document.querySelector('.reason-option.selected');
    if (!selectedOption) {
      alert('Please select a cancellation reason');
      return;
    }
    
    let reason = selectedOption.dataset.reason;
    if (reason === 'Other reason') {
      const customReason = document.getElementById('customReasonTextarea').value.trim();
      if (customReason) {
        reason = customReason;
      }
    }
    
    // Process cancellation
    const orders = JSON.parse(localStorage.getItem('orders')) || [];
    const index = orders.findIndex(o => o.id === currentCancellingOrderId || o.orderId === currentCancellingOrderId);
    
    if (index !== -1) {
      orders[index].cancelled = true;
      orders[index].cancelledDate = new Date().toISOString();
      orders[index].cancellationReason = reason;
      
      localStorage.setItem('orders', JSON.stringify(orders));
      alert('‚úÖ Your order has been cancelled.');
      renderAllOrders();
      closeCancellationModal();
    }
  });
  
  // Close modal when clicking outside
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeCancellationModal();
    }
  });
});






  // Auto-run
  window.onload = () => {
   renderAllOrders();

  };
    
  </script>

  <!-- Cancellation Modal -->
  <div id="cancellationModal" class="cancellation-modal">
    <div class="cancellation-modal-content">
      <div class="cancellation-modal-header">
        <h3 class="cancellation-modal-title">Cancel Order</h3>
        <button class="close-cancellation-modal">&times;</button>
      </div>
      <div class="cancellation-reason-options">
        <div class="reason-option" data-reason="Changed my mind">Changed my mind</div>
        <div class="reason-option" data-reason="Found better price elsewhere">Found better price elsewhere</div>
        <div class="reason-option" data-reason="Ordered by mistake">Ordered by mistake</div>
        <div class="reason-option" data-reason="Delivery time too long">Delivery time too long</div>
        <div class="reason-option" data-reason="Other reason">Other reason</div>
      </div>
      <div class="custom-reason-container">
        <textarea 
          id="customReasonTextarea" 
          class="custom-reason-textarea" 
          placeholder="Please specify your reason (optional)..."
          style="display: none;"></textarea>
      </div>
      <div class="cancellation-modal-actions">
        <button class="cancellation-modal-btn cancel">Go Back</button>
        <button class="cancellation-modal-btn submit">Confirm Cancellation</button>
      </div>
    </div>
  </div>


</body>
</html>
