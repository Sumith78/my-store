<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Track Order</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
    }
    header {
      background-color: #074c63;
      color: white;
      padding: 1.2rem;
      text-align: center;
      font-size: 1.6rem;
      font-weight: bold;
      position: relative;
    }
    
    .container {
      max-width: 600px;
      margin: 2rem auto;
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow-x: hidden;
    }
    
    .user-email {
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
      word-wrap: break-word;
    }
    .timeline-section {
      background-color: #f9f9f9;
      border-radius: 10px;
      padding: 1.2rem;
      margin-bottom: 1.8rem;
      overflow-x: auto;
    }
    .timeline-header {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .status-bar {
      display: flex;
      justify-content: space-between;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 1rem;
    }
    .status-step {
      text-align: center;
      min-width: 80px;
      flex-shrink: 0;
      color: #888;
    }
    .status-step.active {
      color: #074c63;
      font-weight: bold;
    }
    .status-step .circle {
      width: 28px;
      height: 28px;
      background-color: #ccc;
      border-radius: 50%;
      margin: 0 auto 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .status-step.active .circle {
      background-color: #074c63;
    }
    .status-step .icon {
      font-size: 1.1rem;
    }
    
    .summary h3 {
      margin-bottom: 1rem;
    }
    .item {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      gap: 1rem;
    }
    .item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
    }
    .item-name {
      flex: 1;
      font-size: 0.95rem;
    }
    .item-price {
      white-space: nowrap;
      font-weight: 500;
    }
    
    .print-btn {
      display: block;
      margin: 2rem auto 0;
      padding: 12px 24px;
      background-color: #074c63;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .print-btn:hover {
      background-color: #05394a;
    }
    
    @media screen and (max-width: 600px) {
      .status-step .circle {
        width: 24px;
        height: 24px;
      }
      .item img {
        width: 40px;
        height: 40px;
      }
      .timeline-header {
        flex-direction: column;
        text-align: center;
      }
    }

    .back-btn {
      position: absolute;
      left: 20px;
      top: 3px;
      font-size: 3rem;
      cursor: pointer;
      color: white;
      user-select: none;
    }
    
    
  </style>
</head>
<body>
  <header>
    <span class="back-btn" onclick="window.location.href='index.html'">&#8592;</span>
    Track Order
  </header>
  

  <div class="container" id="orderContainer">
    <!-- JS will inject the order card here -->
  </div>

  <script>
    function getStatusSteps(orderDateStr) {
      const orderDate = new Date(orderDateStr);
      const today = new Date();
      const diffDays = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));

      const steps = [
        { name: "Order Placed", icon: "✔" },
        { name: "Packed", icon: "📦" },
        { name: "Shipped", icon: "🚚" },
        { name: "Out for Delivery", icon: "📍" },
        { name: "Delivered", icon: "✅" },
      ];

      return steps.map((step, i) => `
        <div class="status-step ${diffDays >= i ? 'active' : ''}">
          <div class="circle"><span class="icon">${step.icon}</span></div>
          <div>${step.name}</div>
        </div>
      `).join('');
    }

    function renderTrackOrder() {
      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      const email = JSON.parse(localStorage.getItem("checkoutDetails"))?.email || "guest@example.com";
      const latestOrder = orders.filter(o => o.email === email).slice(-1)[0];

      if (!latestOrder) {
        document.getElementById("orderContainer").innerHTML = `
          <p style="text-align:center; color: gray;">No orders found.</p>`;
        return;
      }

      const itemsHTML = latestOrder.items.map(item => `
        <div class="item">
          <img src="${item.image || 'https://via.placeholder.com/50'}" />
          <div class="item-name">${item.name}</div>
          <div class="item-price">1 × ₹${item.price}</div>
        </div>
      `).join('');

      const estimatedDate = new Date(Date.now() + 6 * 86400000).toDateString();

      document.getElementById("orderContainer").innerHTML = `
        <div class="user-email">${latestOrder.email}</div>

        <div class="timeline-section">
          <div class="timeline-header">
            <div>
              <strong>Ordered on</strong><br>
              ${new Date(latestOrder.date).toDateString()}
            </div>
            <div style="text-align:right;">
              <strong>Estimated delivery</strong><br>
              by ${latestOrder.estimatedDelivery}
            </div>
          </div>

          <div class="status-bar">
            ${getStatusSteps(latestOrder.date)}
          </div>
        </div>

        <div class="summary">
          <h3>Summary</h3>
          ${itemsHTML}
          <button class="print-btn" onclick="printSummary()">Print Summary</button>
        </div>
      `;
    }

    async function printSummary() {
      const order = JSON.parse(localStorage.getItem("orders")).slice(-1)[0];
      const choice = confirm("Click OK to Print, or Cancel to Download PDF");
  
      const steps = [
        { name: "Order Placed", icon: "✔" },
        { name: "Packed", icon: "📦" },
        { name: "Shipped", icon: "🚚" },
        { name: "Out for Delivery", icon: "📍" },
        { name: "Delivered", icon: "✅" },
      ];
  
      const orderDate = new Date(order.date);
      const today = new Date();
      const diffDays = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
  
      const statusHTML = steps.map((step, i) => {
        return `<li>${diffDays >= i ? '✅' : '⬜'} ${step.name}</li>`;
      }).join('');
  
      if (choice) {
        // 🖨 Print Option
        const w = window.open();
        w.document.write(`
          <html>
            <head>
              <title>Order Summary</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h2 { text-align: center; }
                .section { margin-bottom: 20px; }
                ul { padding-left: 20px; }
                .item { margin-bottom: 10px; }
                img { width: 50px; height: 50px; object-fit: cover; vertical-align: middle; margin-right: 10px; }
              </style>
            </head>
            <body>
              <h2>Order Summary</h2>
              <div class="section"><strong>Email:</strong> ${order.email}</div>
              <div class="section"><strong>Ordered on:</strong> ${orderDate.toDateString()}</div>
              <div class="section"><strong>Estimated delivery:</strong> ${order.estimatedDelivery}</div>
              <div class="section">
                <strong>Order Status:</strong>
                <ul>${statusHTML}</ul>
              </div>
              <div class="section">
                <strong>Items:</strong>
                <ul>
                  ${order.items.map(item => `
                    <li class="item">
                      <img src="${item.image || 'https://via.placeholder.com/50'}" />
                      ${item.name} — ₹${item.price}
                    </li>
                  `).join('')}
                </ul>
              </div>
            </body>
          </html>
        `);
        w.document.close();
        w.print();
      } else {
        // 📄 PDF Option
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
  
        let y = 10;
        doc.setFontSize(16);
        doc.text("Order Summary", 10, y); y += 10;
  
        doc.setFontSize(12);
        doc.text(`Email: ${order.email}`, 10, y); y += 8;
        doc.text(`Ordered on: ${orderDate.toDateString()}`, 10, y); y += 8;
        doc.text(`Estimated delivery: ${order.estimatedDelivery}`, 10, y); y += 10;
  
        doc.text("Order Status:", 10, y); y += 8;
        steps.forEach((step, i) => {
          doc.text(`${diffDays >= i ? '✅' : '⬜'} ${step.name}`, 12, y);
          y += 8;
        });
  
        y += 5;
        doc.text("Items:", 10, y); y += 8;
        order.items.forEach(item => {
          doc.text(`- ${item.name} — ₹${item.price}`, 12, y);
          y += 8;
        });
  
        doc.save("Order_Summary.pdf");
      }
    }

    renderTrackOrder();
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
